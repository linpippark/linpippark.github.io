<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>113學年-南一(五上)數學線上期末測驗系統</title>
    <style>
        :root {
            --primary-color: #2c3e50; /* 專業深藍 */
            --secondary-color: #34495e;
            --accent-color: #3498db; /* 亮藍 */
            --bg-color: #ecf0f1;
            --text-color: #333;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #27ae60;
        }

        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding-bottom: 80px; /* Footer space */
        }

        /* Header & Timer */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        h1 { margin: 0; font-size: 1.2rem; }
        #timer { font-size: 1.5rem; font-weight: bold; font-family: monospace; }
        .timer-warning { color: var(--warning-color); animation: blink 1s infinite; }
        .timer-danger { color: var(--danger-color); animation: blink 0.5s infinite; }

        @keyframes blink { 50% { opacity: 0.5; } }

        /* Main Container */
        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .section-title {
            border-left: 5px solid var(--accent-color);
            padding-left: 10px;
            margin-top: 30px;
            margin-bottom: 15px;
            color: var(--secondary-color);
        }

        /* Questions */
        .question-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            transition: all 0.3s ease;
        }

        .question-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .q-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .q-num { font-weight: bold; color: var(--primary-color); }
        .q-content { font-size: 1.1rem; margin-bottom: 15px; line-height: 1.6; }
        
        /* Mark for review checkbox */
        .mark-review {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: var(--warning-color);
            cursor: pointer;
        }
        .mark-review input { margin-right: 5px; }

        /* Input types */
        .options-group label {
            display: block;
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
        }
        .options-group label:hover { background-color: #f0f8ff; }
        
        input[type="text"], input[type="number"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 200px;
            font-size: 1rem;
        }

        /* Footer Stats */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--secondary-color);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }

        .stat-item { font-size: 0.9rem; }
        .stat-val { font-weight: bold; font-size: 1.1rem; margin-left: 5px; }
        
        #submit-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: bold;
        }
        #submit-btn:hover { background-color: #2980b9; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        .modal input { width: 100%; margin: 10px 0; padding: 10px; box-sizing: border-box;}
        
        /* Result Styles */
        .wrong-answer {
            border: 2px solid var(--danger-color);
            background-color: #fadbd8;
        }
        .correct-answer-text {
            color: var(--danger-color);
            font-weight: bold;
            margin-top: 10px;
            display: block;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<header>
    <div>
        <h1>113學年-南一(五上)數學線上期末測驗系統</h1>
        <small>範圍：單元6 ~ 單元9 | 總分：100分</small>
    </div>
    <div id="timer">40:00</div>
</header>

<div class="container" id="quiz-container">
    </div>

<footer>
    <div class="stat-item">已答: <span id="answered-count" class="stat-val">0</span>/50</div>
    <div class="stat-item">未答: <span id="unanswered-count" class="stat-val" style="color:#ffcc00">50</span></div>
    <div class="stat-item">稍後作答: <span id="review-count" class="stat-val" style="color:var(--warning-color)">0</span></div>
    <button id="submit-btn">繳交試卷</button>
</footer>

<div id="password-modal" class="modal">
    <div class="modal-content">
        <h2>請輸入密碼以查看結果</h2>
        <p>為防止誤按或學生提早看答案，請家長輸入密碼。</p>
        <input type="password" id="password-input" placeholder="密碼">
        <button id="verify-pass-btn" style="padding:10px 20px; background:var(--primary-color); color:white; border:none; border-radius:4px;">確認</button>
        <button onclick="document.getElementById('password-modal').style.display='none'" style="margin-top:10px; padding:10px 20px; border:1px solid #ccc; background:white; border-radius:4px;">取消</button>
    </div>
</div>

<div id="result-modal" class="modal">
    <div class="modal-content">
        <h2 id="score-display"></h2>
        <p id="result-msg"></p>
        <button onclick="downloadCSV()" style="padding:10px 20px; background:var(--success-color); color:white; border:none; border-radius:4px;">下載錯題報表 (Excel/Google Sheet)</button>
        <button onclick="location.reload()" style="padding:10px 20px; border:1px solid #ccc; background:white; border-radius:4px; margin-top:10px;">重新測驗</button>
    </div>
</div>

<script>
    // 題庫資料 (50題，依照單元比例分配)
    const questions = [
        // 單元6 異分母分數 (約12題)
        { type: 'tf', q: '【6-1】做異分母分數加減時，要先擴分或約分，把分母變相同，才能相加減。', a: 'T', unit: '6-1' },
        { type: 'tf', q: '【6-3】一包糖果重 4/5 公斤，吃了 1/2 包，是吃了 2/5 公斤。', a: 'T', unit: '6-3' },
        { type: 'choice', q: '【6-1】計算 1/2 ＋ 1/3 ＝？', options: ['2/5', '5/6', '1/6', '2/6'], a: 1, unit: '6-1' },
        { type: 'choice', q: '【6-2】計算 5/6 － 3/8 ＝？', options: ['2/24', '11/24', '1/12', '11/12'], a: 1, unit: '6-2' },
        { type: 'choice', q: '【6-2】甲數是 2 又 1/4，乙數是 1 又 2/3，甲、乙兩數的差是多少？', options: ['7/12', '1又1/12', '17/12', '5/12'], a: 0, unit: '6-2' },
        { type: 'fill', q: '【6-1】計算 2/9 ＋ 5/12 ＝ (　　)。(請填最簡分數，格式如 23/36)', a: '23/36', unit: '6-1' },
        { type: 'fill', q: '【6-2】計算 3 － 1又4/7 ＝ (　　)。(請填帶分數，格式如 1又3/7)', a: '1又3/7', unit: '6-2' },
        { type: 'fill', q: '【6-3】紅緞帶長 5/8 公尺，藍緞帶比紅緞帶長 1/6 公尺，藍緞帶長 (　　) 公尺。', a: '19/24', unit: '6-3' },
        { type: 'choice', q: '【6-1】下面哪一個算式的答案最大？', options: ['1/2 + 1/3', '1/3 + 1/4', '1/4 + 1/5', '1/5 + 1/6'], a: 0, unit: '6-1' },
        { type: 'fill', q: '【6-3】一瓶果汁有 2 公升，喝了 3/5 公升後，還剩下 (　　) 公升。(填分數)', a: '1又2/5', unit: '6-3' },
        { type: 'fill', q: '【6-1】5/12 + 7/18 = ( )/36 + ( )/36。請問括號中兩個數字的和是多少？', a: '29', unit: '6-1' }, // 15+14
        { type: 'choice', q: '【6-3】有一條路修了全長的 3/7，還剩下 200 公尺沒修，這條路全長多少公尺？(進階)', options: ['350', '400', '450', '280'], a: 0, unit: '6-3' },

        // 單元7 整數四則 (約12題)
        { type: 'tf', q: '【7-1】在沒有括號的算式中，要先算加減，後算乘除。', a: 'F', unit: '7-1' },
        { type: 'tf', q: '【7-3】分配律公式：(A + B) × C = A × C + B × C。', a: 'T', unit: '7-3' },
        { type: 'choice', q: '【7-1】720 ÷ 8 ÷ 9 的答案與下列何者相同？', options: ['720 ÷ (8 × 9)', '720 ÷ 8 × 9', '720 × 8 ÷ 9', '720 ÷ (8 ÷ 9)'], a: 0, unit: '7-1' },
        { type: 'choice', q: '【7-2】計算 100 － 20 × 4 ＝？', options: ['320', '20', '80', '16'], a: 1, unit: '7-2' },
        { type: 'fill', q: '【7-4】利用簡化計算：199 × 38 = (200 - 1) × 38 = 7600 - (　　) = 7562。', a: '38', unit: '7-4' },
        { type: 'fill', q: '【7-4】計算 125 × 37 × 8 ＝ (　　)。', a: '37000', unit: '7-4' },
        { type: 'choice', q: '【7-3】99 × 25 + 25 的答案與下列何者相同？', options: ['99 × 50', '100 × 25', '99 × 25', '100 × 50'], a: 1, unit: '7-3' },
        { type: 'fill', q: '【7-2】計算 4500 ÷ (150 - 60) × 2 = (　　)。', a: '100', unit: '7-2' },
        { type: 'fill', q: '【7-4】計算 5600 ÷ 25 ÷ 4 ＝ (　　)。', a: '56', unit: '7-4' },
        { type: 'choice', q: '【7-2】一箱飲料有 24 瓶，每瓶 15 元，買 5 箱共要付多少元？', options: ['360', '1200', '1800', '7200'], a: 2, unit: '7-2' },
        { type: 'fill', q: '【7-3】(38 + 52) × 6 = 38 × 6 + 52 × (　　)。', a: '6', unit: '7-3' },
        { type: 'fill', q: '【7-2】計算 180 - 80 ÷ 4 = (　　)。', a: '160', unit: '7-2' },

        // 單元8 面積 (約13題) - 面積計算請填數字
        { type: 'tf', q: '【8-1】平行四邊形的面積公式是「底 × 高 ÷ 2」。', a: 'F', unit: '8-1' },
        { type: 'tf', q: '【8-4】兩個三角形如果「等底等高」，它們的面積一定相等，形狀也一定一樣。', a: 'F', unit: '8-4' }, // 形狀不一定一樣
        { type: 'choice', q: '【8-2】一個三角形的底是 10 公分，高是 8 公分，面積是多少平方公分？', options: ['80', '40', '18', '20'], a: 1, unit: '8-2' },
        { type: 'fill', q: '【8-1】平行四邊形底 15m，高 4m，面積是 (　　) 平方公尺。', a: '60', unit: '8-1' },
        { type: 'fill', q: '【8-3】梯形上底 5cm，下底 9cm，高 6cm，面積是 (　　) 平方公分。', a: '42', unit: '8-3' },
        { type: 'choice', q: '【8-5】如果把平行四邊形的底變成原來的 2 倍，高不變，面積會變成原來的幾倍？', options: ['2倍', '4倍', '不變', '1/2倍'], a: 0, unit: '8-5' },
        { type: 'fill', q: '【8-2】一個三角形面積是 24 平方公分，底是 6 公分，請問高是 (　　) 公分。', a: '8', unit: '8-2' },
        { type: 'choice', q: '【8-3】梯形面積公式中，為什麼要「除以 2」？', options: ['因為有兩個底', '因為它是兩個完全一樣的梯形拼成一個平行四邊形', '為了計算方便', '以上皆非'], a: 1, unit: '8-3' },
        { type: 'fill', q: '【8-1】一塊平行四邊形土地，底 200 公尺，高 50 公尺，面積是 (　　) 公畝。', a: '100', unit: '8-1' },
        { type: 'fill', q: '【8-4】三角形的底擴大 3 倍，高擴大 2 倍，面積會擴大 (　　) 倍。', a: '6', unit: '8-4' },
        { type: 'choice', q: '【8-5】有一塊梯形農地，上底 10m，下底 20m，高 15m，每平方公尺種 4 棵菜，共可種幾棵？', options: ['225', '450', '900', '1800'], a: 2, unit: '8-5' }, // Area=225, 225*4=900
        { type: 'fill', q: '【8-2】直角三角形的兩股分別為 6cm 與 8cm，斜邊為 10cm，此三角形面積為 (　　) 平方公分。', a: '24', unit: '8-2' },
        { type: 'fill', q: '【8-3】(應用題) 梯形面積 100 平方公分，高 10 公分，上底 8 公分，下底是 (　　) 公分。', a: '12', unit: '8-3' },

        // 單元9 時間 (約13題)
        { type: 'tf', q: '【9-1】計算時間的乘法時，若分的位置滿 60，要進位到時。', a: 'T', unit: '9-1' },
        { type: 'choice', q: '【9-1】2 時 15 分 × 3 ＝？', options: ['6時15分', '6時45分', '6時30分', '7時15分'], a: 1, unit: '9-1' },
        { type: 'fill', q: '【9-2】10 日 20 時 ÷ 5 ＝ (　　) 日 (　　) 時。(格式：2日4時)', a: '2日4時', unit: '9-2' },
        { type: 'fill', q: '【9-1】45 分 30 秒 × 4 ＝ (　　) 分 (　　) 秒。(需換算，格式：3分2秒)', a: '3分2秒', unit: '9-1' }, // 182分0秒 -> 3小時2分 這裡題目設計要小心，答案應為 182分=3時2分
        // 修正上一題：182分=3時2分。但題目問幾分幾秒，通常會保持分。
        // 改題：2分30秒 x 4 = 10分0秒。
        { type: 'fill', q: '【9-1】2 分 30 秒 × 4 ＝ (　　) 分 (　　) 秒。(格式：10分0秒)', a: '10分0秒', unit: '9-1' },
        
        { type: 'choice', q: '【9-2】8 分 24 秒 ÷ 6 ＝？', options: ['1分14秒', '1分24秒', '1分34秒', '1分4秒'], a: 1, unit: '9-2' }, // 480+24=504, 504/6=84s=1m24s
        { type: 'fill', q: '【9-3】小明每天運動 40 分鐘，一星期共運動 (　　) 小時 (　　) 分鐘。(格式：4小時40分鐘)', a: '4小時40分鐘', unit: '9-3' },
        { type: 'fill', q: '【9-3】製作一個零件需要 18 分鐘，3 小時可以製作 (　　) 個零件。', a: '10', unit: '9-3' },
        { type: 'choice', q: '【9-1】一堂課 40 分鐘，上了 5 堂課，中間不下課，共是幾小時幾分？', options: ['3小時20分', '2小時40分', '3小時40分', '200分'], a: 0, unit: '9-1' },
        { type: 'fill', q: '【9-2】把 15 小時平均分成 4 段，每段是 (　　) 小時 (　　) 分鐘。(格式：3小時45分鐘)', a: '3小時45分鐘', unit: '9-2' },
        { type: 'fill', q: '【9-3】(應用題) 爸爸跑操場一圈花 2 分 50 秒，跑 6 圈共花 (　　) 分 (　　) 秒。(格式：17分0秒)', a: '17分0秒', unit: '9-3' },
        { type: 'fill', q: '【9-3】機器運轉 7200 秒，是 (　　) 小時。', a: '2', unit: '9-3' },
        { type: 'fill', q: '【9-2】34 時 ÷ 8 = (　　) 時 (　　) 分。(格式：4時15分)', a: '4時15分', unit: '9-2' }
    ];

    let timer;
    let totalTime = 40 * 60; // 40 minutes in seconds
    let userAnswers = {};
    let markedForReview = new Set();
    let isSubmitting = false;

    // Shuffle function if needed (Optional, keeping fixed for now to track Unit balance)

    function renderQuestions() {
        const container = document.getElementById('quiz-container');
        let html = '';

        questions.forEach((item, index) => {
            let optionsHtml = '';
            
            if (item.type === 'tf') {
                optionsHtml = `
                    <div class="options-group">
                        <label><input type="radio" name="q${index}" value="T" onchange="updateStat(${index}, this.value)"> 是 (True)</label>
                        <label><input type="radio" name="q${index}" value="F" onchange="updateStat(${index}, this.value)"> 非 (False)</label>
                    </div>`;
            } else if (item.type === 'choice') {
                item.options.forEach((opt, optIndex) => {
                    optionsHtml += `
                        <div class="options-group">
                            <label><input type="radio" name="q${index}" value="${optIndex}" onchange="updateStat(${index}, this.value)"> ${optIndex+1}. ${opt}</label>
                        </div>`;
                });
            } else if (item.type === 'fill') {
                optionsHtml = `<div class="options-group">
                    <input type="text" id="input-q${index}" placeholder="請輸入答案" onchange="updateStat(${index}, this.value)">
                </div>`;
            }

            html += `
                <div class="question-card" id="card-${index}">
                    <div class="q-header">
                        <span class="q-num">第 ${index + 1} 題</span>
                        <label class="mark-review">
                            <input type="checkbox" onchange="toggleReview(${index})"> 稍後作答
                        </label>
                    </div>
                    <div class="q-content">${item.q}</div>
                    ${optionsHtml}
                    <span id="feedback-${index}" class="correct-answer-text hidden"></span>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function startTimer() {
        const timerEl = document.getElementById('timer');
        timer = setInterval(() => {
            totalTime--;
            let m = Math.floor(totalTime / 60);
            let s = totalTime % 60;
            timerEl.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

            // Alerts
            if (totalTime === 15 * 60) alert('提醒：考試時間剩下 15 分鐘！');
            if (totalTime === 6 * 60) alert('提醒：考試時間剩下 6 分鐘！請檢查是否還有未答題目。');
            if (totalTime === 2 * 60) {
                alert('警告：考試時間剩下 2 分鐘！即將自動交卷。');
                timerEl.classList.add('timer-danger');
            } else if (totalTime <= 5 * 60) {
                timerEl.classList.add('timer-warning');
            }

            if (totalTime <= 0) {
                clearInterval(timer);
                alert('時間到！系統自動交卷。');
                submitExam(true);
            }
        }, 1000);
    }

    function updateStat(index, value) {
        if (value && value.trim() !== "") {
            userAnswers[index] = value;
        } else {
            delete userAnswers[index];
        }
        renderStats();
    }

    function toggleReview(index) {
        if (markedForReview.has(index)) {
            markedForReview.delete(index);
            document.getElementById(`card-${index}`).style.borderColor = '#ddd';
        } else {
            markedForReview.add(index);
            document.getElementById(`card-${index}`).style.borderColor = 'var(--warning-color)';
        }
        renderStats();
    }

    function renderStats() {
        const answered = Object.keys(userAnswers).length;
        document.getElementById('answered-count').textContent = answered;
        document.getElementById('unanswered-count').textContent = 50 - answered;
        document.getElementById('review-count').textContent = markedForReview.size;
    }

    document.getElementById('submit-btn').addEventListener('click', () => {
        const answered = Object.keys(userAnswers).length;
        if (answered < 50) {
            if (!confirm(`您還有 ${50 - answered} 題未作答，確定要交卷嗎？`)) return;
        }
        document.getElementById('password-modal').style.display = 'flex';
    });

    document.getElementById('verify-pass-btn').addEventListener('click', () => {
        const pass = document.getElementById('password-input').value;
        if (pass === '1234') {
            document.getElementById('password-modal').style.display = 'none';
            submitExam(false);
        } else {
            alert('密碼錯誤！');
        }
    });

    function submitExam(auto) {
        if (isSubmitting) return;
        isSubmitting = true;
        clearInterval(timer);

        let score = 0;
        let wrongList = [];

        questions.forEach((q, i) => {
            let isCorrect = false;
            let userAns = userAnswers[i] ? userAnswers[i].trim() : "";
            
            // Normalize answers for checking
            if (q.type === 'tf') {
                if (userAns === q.a) isCorrect = true;
            } else if (q.type === 'choice') {
                if (userAns == q.a) isCorrect = true;
            } else if (q.type === 'fill') {
                // Remove spaces for comparison and handle Chinese chars if needed
                if (userAns.replace(/\s/g, '') === q.a.replace(/\s/g, '')) isCorrect = true;
            }

            if (isCorrect) {
                score += 2; // 100 points / 50 qs = 2 pts each
            } else {
                wrongList.push({
                    id: i + 1,
                    q: q.q,
                    user: userAns || "未作答",
                    correct: (q.type === 'choice') ? q.options[q.a] : (q.type === 'tf' ? (q.a === 'T'?'是':'非') : q.a),
                    unit: q.unit
                });
                
                // Highlight wrong answers on UI
                const card = document.getElementById(`card-${i}`);
                card.classList.add('wrong-answer');
                const fb = document.getElementById(`feedback-${i}`);
                fb.classList.remove('hidden');
                let correctText = (q.type === 'choice') ? `${q.a+1}. ${q.options[q.a]}` : (q.type === 'tf' ? (q.a === 'T'?'是':'非') : q.a);
                fb.textContent = `正確答案：${correctText}`;
            }
        });

        // Store result for CSV export
        window.lastResult = wrongList;
        window.finalScore = score;

        // Show Result Modal
        const modal = document.getElementById('result-modal');
        document.getElementById('score-display').textContent = `總分：${score} 分`;
        document.getElementById('result-msg').innerHTML = score === 100 ? "太棒了！滿分！" : `共有 ${wrongList.length} 題答錯，請下載報表檢討。`;
        modal.style.display = 'flex';
        
        // Scroll to top
        window.scrollTo(0,0);
    }

    function downloadCSV() {
        if (!window.lastResult || window.lastResult.length === 0) {
            alert("沒有錯題可以匯出！");
            return;
        }

        // Add BOM for Excel Chinese character support
        let csvContent = "\uFEFF題號,單元,題目,您的答案,正確答案\n";
        
        window.lastResult.forEach(row => {
            // Escape quotes in CSV
            let qClean = row.q.replace(/"/g, '""');
            csvContent += `${row.id},${row.unit},"${qClean}","${row.user}","${row.correct}"\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "math_result.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Init
    renderQuestions();
    startTimer();

</script>

</body>
</html>