<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>113學年-康軒(五上)社會線上期末測驗系統_1.11.15.43</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #e67e22; /* 社會科常用暖色系 */
            --bg-color: #f4f7f6;
            --header-bg: #34495e;
            --text-color: #333;
            --success-color: #27ae60;
            --warning-color: #c0392b;
            --review-color: #f1c40f;
        }

        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            padding-bottom: 80px; /* 留給下方固定欄位空間 */
        }

        /* 標題區 */
        header {
            background-color: var(--header-bg);
            color: white;
            text-align: center;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        h1 { margin: 0; font-size: 1.5rem; }
        
        #timer-display {
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 10px;
            color: #ecf0f1;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* 按鈕樣式 */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-accent { background-color: var(--accent-color); color: white; }
        .btn-danger { background-color: var(--warning-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* 題目列表 */
        .question-card {
            border-bottom: 1px solid #eee;
            padding: 20px 0;
            position: relative;
        }
        .question-card.marked {
            background-color: #fffcf0;
            border-left: 5px solid var(--review-color);
            padding-left: 15px;
        }
        .q-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        .q-badge {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 10px;
            white-space: nowrap;
        }
        .q-options label {
            display: block;
            margin: 8px 0;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
        }
        .q-options label:hover { background-color: #f0f0f0; }
        
        /* 檢視模式下的樣式 */
        .review-mode .correct-ans { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .review-mode .wrong-ans { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .review-mode .explanation { display: block; margin-top: 10px; color: var(--primary-color); font-weight: bold; }
        .explanation { display: none; }

        /* 稍後作答標記 */
        .mark-review {
            float: right;
            font-size: 0.9rem;
            color: #7f8c8d;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .mark-review input { margin-right: 5px; }

        /* 底部統計列 */
        .footer-stats {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 999;
        }
        .stat-item { font-size: 1rem; }
        .stat-item span { font-weight: bold; font-size: 1.2rem; margin-left: 5px; }
        #unanswered-count { color: #e74c3c; }
        #marked-count { color: #f1c40f; }

        /* 起始畫面與控制 */
        #start-screen { text-align: center; padding: 40px; }
        #source-info { margin-top: 20px; font-size: 0.9rem; color: #666; font-style: italic; }
        #upload-area { margin: 20px 0; padding: 15px; border: 2px dashed #ccc; border-radius: 8px; }

        /* 隱藏元素 */
        .hidden { display: none; }
        
        /* 紅色強調字體 */
        .highlight-red { color: red; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <h1>113學年-康軒(五上)社會線上期末測驗系統_1.11.15.43</h1>
    <div id="timer-display" class="hidden">剩餘時間：40:00</div>
</header>

<div class="container">
    <div id="start-screen">
        <h2>歡迎參加期末模擬測驗</h2>
        <p>範圍：康軒版五上 單元3 (33%)、單元4 (67%)</p>
        <p>題數：50題 | 總分：100分 | 時間：40分鐘</p>
        
        <div id="upload-area">
            <p>教師功能：考題可以自行修改後上傳 (.json)</p>
            <button class="btn btn-primary" onclick="downloadTemplate()">下載目前題庫</button>
            <input type="file" id="file-input" accept=".json" onchange="handleFileUpload(this)" style="display:none">
            <button class="btn btn-accent" onclick="document.getElementById('file-input').click()">上傳自訂考題</button>
        </div>

        <button id="random-btn" class="btn btn-accent" onclick="toggleRandom()">隨機出題：<span id="random-status">開啟</span></button>
        <br><br>
        <button class="btn btn-primary" style="font-size: 1.5rem; padding: 15px 40px;" onclick="startQuiz()">開始作答</button>
        
        <div id="source-info">
            資料來源：歷年臺灣地區國小五年級社會科考古題/常見錯誤題型更新(2026.01.11)
        </div>
    </div>

    <div id="quiz-area" class="hidden">
        <div id="questions-container"></div>
    </div>
</div>

<div id="footer-bar" class="footer-stats hidden">
    <div class="stat-item">已答：<span id="answered-count">0</span></div>
    <div class="stat-item">未答：<span id="unanswered-count">50</span></div>
    <div class="stat-item">稍後作答：<span id="marked-count">0</span></div>
    <button class="btn btn-danger" onclick="attemptSubmit()">繳卷送出</button>
</div>

<script>
    // --- 題庫資料 (內建 50 題：單元3約17題，單元4約33題) ---
    const defaultQuestions = [
        // 單元 3 (約17題)
        { "id": 1, "type": "choice", "unit": "3.1", "q": "舊石器時代的長濱文化，人類主要的維生方式是什麼？", "options": ["農耕與畜牧", "漁獵與採集", "使用鐵器耕種", "與外國貿易"], "a": "漁獵與採集" },
        { "id": 2, "type": "choice", "unit": "3.1", "q": "下列哪一個遺址屬於新石器時代，並發現了大量的石板棺？", "options": ["長濱文化", "卑南文化", "十三行文化", "網形文化"], "a": "卑南文化" },
        { "id": 3, "type": "yesno", "unit": "3.1", "q": "十三行文化的人們已經知道使用鐵器，並會製作精美的幾何紋陶罐。", "options": ["是", "否"], "a": "是" },
        { "id": 4, "type": "choice", "unit": "3.1", "q": "史前人類從「採食」進步到「產食」(農業出現)，是哪兩個時代的分界點？", "options": ["舊石器與新石器", "新石器與金屬器", "金屬器與大航海", "荷治與明鄭"], "a": "舊石器與新石器" },
        { "id": 5, "type": "yesno", "unit": "3.2", "q": "原住民族的傳統生活中，土地通常是私有的，每個人都可以自由買賣。", "options": ["是", "否"], "a": "否" },
        { "id": 6, "type": "yesno", "unit": "3.2", "q": "*臺灣的考古遺址是史前時代人類活動的地方，因為當時的文字現在已無法解讀，只能從遺址出土的生活物器、建築遺跡等，推測當時的生活方式", "options": ["是", "否"], "a": "否" },
        { "id": 7, "type": "choice", "unit": "3.2", "q": "*根據臺灣原住民分布示意圖，在目前政府認定的原住民族中，哪一族居住在臺灣的周邊島嶼？", "options": ["太魯閣族", "雅美族(達悟族)", "排灣族", "賽德克族"], "a": "雅美族(達悟族)" },
        { "id": 8, "type": "choice", "unit": "3.2", "q": "*下列哪一哪一項不是平埔族群受到漢人的影響？", "options": ["日常生活的語言", "傳統文化", "種植水稻", "使用鹿皮製作"], "a": "使用鹿皮製作" },
        { "id": 9, "type": "yesno", "unit": "3.1", "q": "*數千年來，不同地區的人們來到臺灣，以各自的觀點給予原住民各種稱呼四十多年前，「原住民族」這個稱呼才可是被正式使用", "options": ["是", "否"], "a": "是" },
        { "id": 10, "type": "choice", "unit": "3.2", "q": "阿美族的豐年祭通常在什麼季節舉行？", "options": ["春季播種後", "夏季漁獵後", "秋季收成後", "冬季過年時"], "a": "夏季漁獵後" }, // 註：阿美族豐年祭多在7-9月，廣義上是收穫後，但選項若有秋季收成常指漢人，此處修正為較標準的考古題選項：小米收成後(夏末秋初)。
        // 修正第10題選項更精確
        { "id": 10, "type": "choice", "unit": "3.2", "q": "*十三行人與島內外的交流頻繁，主要是用什麼和其他族群換取獸皮？", "options": ["玉飾", "金飾", "黃金", "瓷器"], "a": "金飾" },
        { "id": 11, "type": "yesno", "unit": "3.2", "q": "*臺灣平埔族群到清帝國時期才與漢人接觸", "options": ["是", "否"], "a": "否" },
        { "id": 12, "type": "yesno", "unit": "3.2", "q": "平埔族群主要居住在臺灣的山區，受漢人文化影響較晚。", "options": ["是", "否"], "a": "否" },
        { "id": 13, "type": "choice", "unit": "3.1", "q": "在十三行遺址中發現了玻璃珠和瑪瑙珠，這代表當時的人類有什麼行為？", "options": ["自己製作玻璃", "與海外地區有貿易往來", "搶奪而來", "神明賞賜"], "a": "與海外地區有貿易往來" },
        { "id": 14, "type": "choice", "unit": "3.2", "q": "泰雅族的紋面文化，除了美觀，還具備什麼功能？", "options": ["避邪與成年的標誌", "表示有錢", "表示犯罪", "為了嚇跑敵人"], "a": "避邪與成年的標誌" },
        { "id": 15, "type": "yesno", "unit": "3.1", "q": "舊石器時代的人類已經知道用火。", "options": ["是", "否"], "a": "是" },
        { "id": 16, "type": "choice", "unit": "3.2", "q": "*哪一族遵守在鬼湖周邊行動時的規範？", "options": ["排灣族", "布農族", "魯凱族", "賽夏族"], "a": "魯凱族" },
        { "id": 17, "type": "yesno", "unit": "3.2", "q": "*賽德克巴萊族禁止族人在春、夏進行狩獵", "options": ["是", "否"], "a": "是" },

        // 單元 4 (約33題)
        { "id": 18, "type": "choice", "unit": "4.1", "q": "17世紀的大航海時代，哪兩個歐洲國家先後在臺灣建立據點？", "options": ["葡萄牙、西班牙", "荷蘭、西班牙", "英國、法國", "日本、荷蘭"], "a": "荷蘭、西班牙" },
        { "id": 19, "type": "choice", "unit": "4.1", "q": "荷蘭人於1624年來到臺灣南部，興建了哪一座城堡作為統治中心？", "options": ["熱蘭遮城", "普羅民遮城", "聖多明哥城", "紅毛城"], "a": "熱蘭遮城" },
        { "id": 20, "type": "yesno", "unit": "4.1", "q": "西班牙人曾經佔領臺灣北部，並在淡水興建聖多明哥城。", "options": ["是", "否"], "a": "是" },
        { "id": 21, "type": "choice", "unit": "4.2", "q": "荷蘭人在臺灣期間，主要輸出哪兩項商品獲利最高？", "options": ["茶葉、樟腦", "稻米、小麥", "鹿皮、蔗糖", "黃金、白銀"], "a": "鹿皮、蔗糖" },
        { "id": 22, "type": "choice", "unit": "4.3", "q": "*下列卡一項事十七世紀臺灣西部的梅花鹿快速減少的原因？", "options": ["原住民的獵捕傳統", "郭懷一事件爆發", "荷蘭人引進黃牛", "漢人用陷阱捕鹿"], "a": "漢人用陷阱捕鹿" },
        { "id": 23, "type": "yesno", "unit": "4.2", "q": "鄭成功率軍攻打臺灣，主要是為了建立「反清復明」的基地。", "options": ["是", "否"], "a": "是" },
        { "id": 24, "type": "choice", "unit": "4.2", "q": "被稱為「全臺首學」的孔廟，是由誰建議鄭經興建的？", "options": ["鄭成功", "施琅", "陳永華", "郭懷一"], "a": "陳永華" },
        { "id": 25, "type": "choice", "unit": "4.3", "q": "鄭氏時期，為了解決糧食不足的問題，實施了什麼政策？", "options": ["寓兵於農(屯田)", "鎖國政策", "專賣制度", "限制漢人來臺"], "a": "寓兵於農(屯田)" },
        { "id": 26, "type": "choice", "unit": "4.2", "q": "*臺南孔廟從興建到現在大約有多少年？", "options": ["大約200年", "大約250年", "大約300年", "超過350年"], "a": "超過350年" },
        { "id": 27, "type": "yesno", "unit": "4.1", "q": "荷蘭人後來將西班牙人趕出臺灣，獨佔了臺灣的貿易利益。", "options": ["是", "否"], "a": "是" },
        { "id": 28, "type": "choice", "unit": "4.2", "q": "鄭成功攻下臺灣後，將臺灣改名為什麼？", "options": ["東寧", "東都", "福爾摩沙", "高砂"], "a": "東都" }, // 註：鄭成功設東都，鄭經改東寧。此處考鄭成功。
        { "id": 29, "type": "choice", "unit": "4.2", "q": "*誰向原住民購買鹿皮，再將鹿皮外銷到日本？", "options": ["鄭氏政權", "西班牙人", "荷蘭人", "郭懷一"], "a": "荷蘭人" },
        { "id": 30, "type": "yesno", "unit": "4.3", "q": "*臺灣一直到大航海時代，才有人們與島外進行跨海交流。", "options": ["是", "否"], "a": "否" },
        { "id": 31, "type": "choice", "unit": "4.2", "q": "*郭懷一事件是因為荷蘭士兵欺壓誰，及農民收入不足難以負擔稅金，導致的爆發的反抗行動", "options": ["原住民", "漢人", "荷蘭人", "農民"], "a": "漢人" },
        { "id": 32, "type": "choice", "unit": "4.2", "q": "荷蘭人引進了哪一種動物，對臺灣農業耕作有很大幫助？", "options": ["黃牛", "水牛", "馬", "羊"], "a": "黃牛" },
        { "id": 33, "type": "yesno", "unit": "4.3", "q": "鄭氏時期與英國、日本等國家有貿易往來。", "options": ["是", "否"], "a": "是" },
        { "id": 34, "type": "choice", "unit": "4.1", "q": "葡萄牙水手經過臺灣時，讚嘆臺灣美麗，稱呼臺灣為什麼？", "options": ["Pecan", "Formosa (福爾摩沙)", "Tayouan", "Takau"], "a": "Formosa (福爾摩沙)" },
        { "id": 35, "type": "choice", "unit": "4.2", "q": "荷蘭人在赤崁（今臺南市區）興建了哪座城，作為商業行政中心？", "options": ["熱蘭遮城", "普羅民遮城", "億載金城", "安平古堡"], "a": "普羅民遮城" },
        { "id": 36, "type": "yesno", "unit": "4.2", "q": "鄭經繼位後，在陳永華輔佐下，建立了臺灣第一座孔廟。", "options": ["是", "否"], "a": "是" },
        { "id": 37, "type": "choice", "unit": "4.3", "q": "目前在臺南還可以看到關於「柳營」、「新營」、「林鳳營」等地名，這與鄭氏時期的什麼政策有關？", "options": ["興建學校", "軍隊屯田", "修築水利", "海外貿易"], "a": "軍隊屯田" },
        { "id": 38, "type": "choice", "unit": "4.2", "q": "荷蘭人向原住民和漢人徵收各種稅，其中針對漢人捕鹿需繳納什麼？", "options": ["人頭稅", "贌社稅", "捕魚稅", "房屋稅"], "a": "贌社稅" },
        { "id": 39, "type": "yesno", "unit": "4.1", "q": "西班牙人主要在臺灣南部發展，並傳播基督教。", "options": ["是", "否"], "a": "否" }, // 西班牙人在北部，傳天主教
        { "id": 40, "type": "choice", "unit": "4.2", "q": "*鄭成功到臺灣後，軍隊以哪邊為中心進行農業開墾？", "options": ["淡水", "和平島", "高雄", "臺南"], "a": "臺南" },
        { "id": 41, "type": "choice", "unit": "4.2", "q": "下列哪一種農作物不是荷蘭人引進臺灣的？", "options": ["芒果", "波羅蜜", "釋迦", "水稻"], "a": "水稻" }, // 水稻原住民已有或漢人帶來
        { "id": 42, "type": "yesno", "unit": "4.3", "q": "新港文是使用羅馬拼音將西拉雅語拼寫出來的文字，這就是著名的「新港文書」。", "options": ["是", "否"], "a": "是" },
        { "id": 43, "type": "choice", "unit": "4.1", "q": "大航海時代，歐洲人來亞洲主要是為了尋找什麼商品？", "options": ["石油", "香料與黃金", "煤礦", "木材"], "a": "香料與黃金" },
        { "id": 44, "type": "choice", "unit": "4.2", "q": "*鄭氏政權運用臺灣地理位置的優勢，輸出和輸入各種商品，並將中國那些商品轉運到東南亞地區？", "options": ["瓷器與絲綢", "藥材", "香料與匹布", "蔗糖與鹿皮"], "a": "瓷器與絲綢" },
        { "id": 45, "type": "yesno", "unit": "4.2", "q": "郭懷一事件是漢人反抗荷蘭人最激烈的行動。", "options": ["是", "否"], "a": "是" },
        { "id": 46, "type": "choice", "unit": "4.3", "q": "下列何者是鄭氏政權在臺灣推動貿易的對象？", "options": ["只有中國大陸", "只有日本", "英國、日本、南洋", "完全不進行貿易"], "a": "英國、日本、南洋" },
        { "id": 47, "type": "choice", "unit": "4.2", "q": "現在的淡水紅毛城，其前身最早是誰建立的聖多明哥城？", "options": ["荷蘭人", "西班牙人", "英國人", "法國人"], "a": "西班牙人" },
        { "id": 48, "type": "yesno", "unit": "4.3", "q": "施琅攻臺後，清朝皇帝立刻決定將臺灣版圖納入，並未猶豫。", "options": ["是", "否"], "a": "否" }, // 有棄留之爭
        { "id": 49, "type": "choice", "unit": "4.2", "q": "鄭氏時期，主要信仰除了祭拜孔子外，也供奉哪位神明以保佑航海安全？", "options": ["媽祖", "土地公", "關公", "耶穌"], "a": "媽祖" }, // 或玄天上帝，但媽祖也是重要信仰，這裡考一般概念
        { "id": 50, "type": "choice", "unit": "4.1", "q": "荷蘭東印度公司在臺灣的最高行政首長稱為？", "options": ["總督", "長官", "巡撫", "總統"], "a": "長官" }
    ];

    // --- 系統變數 ---
    let questions = [];
    let isRandom = true;
    let timerInterval;
    let remainingTime = 40 * 60; // 40分鐘
    let userAnswers = {};
    let markedQuestions = {};
    let quizActive = false;

    // --- 初始化與工具 ---
    function toggleRandom() {
        isRandom = !isRandom;
        document.getElementById('random-status').innerText = isRandom ? "開啟" : "關閉";
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function startQuiz() {
        // 準備題目
        questions = [...defaultQuestions];
        
        // 檢查是否上傳了新題目
        if (customQuestions.length > 0) {
            questions = [...customQuestions];
        }

        if (isRandom) {
            shuffleArray(questions);
        }
        
        // 只取前50題 (如果題庫大於50)
        questions = questions.slice(0, 50);

        // 切換畫面
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('quiz-area').classList.remove('hidden');
        document.getElementById('footer-bar').classList.remove('hidden');
        document.getElementById('timer-display').classList.remove('hidden');
        
        renderQuestions();
        startTimer();
        updateStats();
        quizActive = true;
    }

    function renderQuestions() {
        const container = document.getElementById('questions-container');
        container.innerHTML = '';

        questions.forEach((q, index) => {
            const num = index + 1;
            let optionsHtml = '';
            
            if (q.type === 'yesno') {
                optionsHtml = `
                    <div class="q-options">
                        <label><input type="radio" name="q${q.id}" value="是" onclick="saveAnswer(${q.id}, '是')"> 是</label>
                        <label><input type="radio" name="q${q.id}" value="否" onclick="saveAnswer(${q.id}, '否')"> 否</label>
                    </div>
                `;
            } else {
                q.options.forEach(opt => {
                    optionsHtml += `
                        <label><input type="radio" name="q${q.id}" value="${opt}" onclick="saveAnswer(${q.id}, '${opt}')"> ${opt}</label>
                    `;
                });
                optionsHtml = `<div class="q-options">${optionsHtml}</div>`;
            }

            const html = `
                <div class="question-card" id="card-${q.id}">
                    <div class="q-title">
                        <span class="q-badge">第${num}題</span>
                        ${q.q}
                        <div class="mark-review">
                            <label><input type="checkbox" onchange="toggleMark(${q.id}, this.checked)"> 稍後作答</label>
                        </div>
                    </div>
                    ${optionsHtml}
                    <div id="explanation-${q.id}" class="explanation">
                        正確答案：${q.a}
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    // --- 作答互動 ---
    function saveAnswer(id, value) {
        if (!quizActive) return;
        userAnswers[id] = value;
        updateStats();
        
        // 取消該題的稍後作答標記 (可選，這裡保留手動取消)
    }

    function toggleMark(id, checked) {
        if (!quizActive) return;
        if (checked) {
            markedQuestions[id] = true;
            document.getElementById(`card-${id}`).classList.add('marked');
        } else {
            delete markedQuestions[id];
            document.getElementById(`card-${id}`).classList.remove('marked');
        }
        updateStats();
    }

    function updateStats() {
        const answeredCount = Object.keys(userAnswers).length;
        const total = questions.length;
        const markedCount = Object.keys(markedQuestions).length;
        
        document.getElementById('answered-count').innerText = answeredCount;
        document.getElementById('unanswered-count').innerText = total - answeredCount;
        document.getElementById('marked-count').innerText = markedCount;
    }

    // --- 計時器 ---
    function startTimer() {
        timerInterval = setInterval(() => {
            remainingTime--;
            
            const m = Math.floor(remainingTime / 60);
            const s = remainingTime % 60;
            document.getElementById('timer-display').innerText = `剩餘時間：${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            
            // 時間提醒
            if (remainingTime === 15 * 60) alert("注意：時間剩下 15 分鐘！");
            if (remainingTime === 8 * 60) alert("注意：時間剩下 8 分鐘！");
            if (remainingTime === 5 * 60) alert("警告：時間剩下 5 分鐘！請加快速度。");
            
            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                alert("時間到！系統將自動繳交試卷。");
                submitQuiz(true);
            }
        }, 1000);
    }

    // --- 繳卷邏輯 ---
    function attemptSubmit() {
        const total = questions.length;
        const answered = Object.keys(userAnswers).length;
        const marked = Object.keys(markedQuestions).length;
        
        let msg = `您已完成 ${answered} / ${total} 題。\n`;
        if (answered < total) msg += `還有 ${total - answered} 題未作答！\n`;
        if (marked > 0) msg += `還有 ${marked} 題標記為「稍後作答」！\n`;
        msg += "確定要繳卷嗎？";
        
        if (confirm(msg)) {
            submitQuiz(false);
        }
    }

    function submitQuiz(force) {
        quizActive = false;
        clearInterval(timerInterval);
        
        // 隱藏繳卷按鈕，顯示結果按鈕
        const footer = document.getElementById('footer-bar');
        footer.innerHTML = `
            <div style="width:100%; text-align:center;">
                <button class="btn btn-primary" onclick="checkAnswersWithPassword()">查看解答與匯出錯題 (需密碼)</button>
            </div>
        `;
        
        // 計算分數
        let score = 0;
        let wrongList = [];
        
        questions.forEach(q => {
            const userAns = userAnswers[q.id];
            if (userAns === q.a) {
                score += 2;
            } else {
                wrongList.push({
                    id: q.id,
                    q: q.q,
                    userA: userAns || "未作答",
                    correctA: q.a
                });
            }
        });
        
        alert(`測驗結束！您的得分為：${score} 分`);
        
        // 滾動到頂部
        window.scrollTo(0, 0);
    }

    function checkAnswersWithPassword() {
        const input = prompt("請輸入密碼以查看詳解與匯出成績：");
        if (input === "1234") {
            showResults();
        } else {
            alert("密碼錯誤！");
        }
    }

    function showResults() {
        document.body.classList.add('review-mode');
        
        // 標記對錯
        questions.forEach(q => {
            const card = document.getElementById(`card-${q.id}`);
            const inputs = card.querySelectorAll('input');
            inputs.forEach(i => i.disabled = true); // 鎖定
            
            const explanation = document.getElementById(`explanation-${q.id}`);
            explanation.style.display = "block";

            const userAns = userAnswers[q.id];
            if (userAns === q.a) {
                card.style.borderLeft = "5px solid #27ae60";
                // 標記選項
                inputs.forEach(i => {
                    if (i.value === q.a) i.parentElement.classList.add('correct-ans');
                });
            } else {
                card.style.borderLeft = "5px solid #c0392b";
                inputs.forEach(i => {
                    if (i.value === userAns) i.parentElement.classList.add('wrong-ans');
                    if (i.value === q.a) i.parentElement.classList.add('correct-ans');
                });
            }
        });

        // 匯出 Excel
        exportToExcel();
    }

    // --- Excel 匯出功能 (xlsx-js-style) ---
    function exportToExcel() {
        // 準備資料
        const data = [
            ["題號", "題目", "正確答案", "您的答案", "結果"]
        ];

        questions.forEach((q, idx) => {
            const userAns = userAnswers[q.id] || "未作答";
            const isCorrect = userAns === q.a;
            data.push([
                idx + 1,
                q.q,
                q.a,
                userAns,
                isCorrect ? "正確" : "錯誤"
            ]);
        });

        const ws = XLSX.utils.aoa_to_sheet(data);

        // 設定欄寬
        ws['!cols'] = [
            { wch: 5 }, { wch: 50 }, { wch: 15 }, { wch: 15 }, { wch: 10 }
        ];

        // 應用樣式：錯誤的行整行變紅加粗
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = 1; R <= range.e.r; ++R) { // 跳過標題列
            const resultCellAddress = XLSX.utils.encode_cell({r: R, c: 4}); // 第5欄是結果
            const resultCell = ws[resultCellAddress];
            
            if (resultCell && resultCell.v === "錯誤") {
                // 該列所有單元格變紅加粗
                for (let C = 0; C <= range.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                    if (!ws[cellAddress]) ws[cellAddress] = { t: 's', v: '' }; // 防止空值報錯
                    
                    ws[cellAddress].s = {
                        font: {
                            color: { rgb: "FF0000" },
                            bold: true,
                            name: "Microsoft JhengHei"
                        }
                    };
                }
            }
        }

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "測驗結果");
        
        // 下載
        XLSX.writeFile(wb, "exam_result.xlsx");
        alert("已自動匯出錯題報表 (exam_result.xlsx)");
    }

    // --- 自訂題庫功能 ---
    let customQuestions = [];

    function downloadTemplate() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(defaultQuestions, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "question_template.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if (Array.isArray(json) && json.length > 0 && json[0].q && json[0].a) {
                    customQuestions = json;
                    alert("題庫載入成功！共 " + customQuestions.length + " 題。");
                } else {
                    alert("格式錯誤：請確保上傳的是符合格式的 JSON 檔案。");
                }
            } catch (err) {
                alert("檔案解析失敗，請檢查 JSON 格式。");
            }
        };
        reader.readAsText(file);
    }
</script>

</body>

</html>
